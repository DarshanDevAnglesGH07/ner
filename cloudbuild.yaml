name: Streamlit CI/CD with Artifact Registry and Authentication

on:
  push:
    branches: [main]

steps:
  - name: Install dependencies
    run: pip install -r requirements.txt
  - name: Run tests
    run: pytest
  - name: Build Docker image
    run: gcloud builds submit --tag us-central1-docker.pkg.dev/dspl-ai-ml-coe-pocs/ner-with-rl/reinforcement-learning:latest .
  - name: Deploy to Cloud Run with Authentication
    run: |
      gcloud auth configure-docker us-central1-docker.pkg.dev
      gcloud iam service-accounts keys create deployment-key.json \
        --iam-account="for-ner@dspl-ai-ml-coe-pocs.iam.gserviceaccount.com"
      gcloud run deploy your-service-name \
        --image us-central1-docker.pkg.dev/dspl-ai-ml-coe-pocs/ner-with-rl/reinforcement-learning:latest \
        --platform managed \
        --service-account="for-ner@dspl-ai-ml-coe-pocs.iam.gserviceaccount.com" \
        --set-iam-policy="serviceAccount:for-ner@dspl-ai-ml-coe-pocs.iam.gserviceaccount.com:roles/run.invoker" \
        --no-allow-unauthenticated